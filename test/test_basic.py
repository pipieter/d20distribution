import pytest

from d20distribution import parse
from d20distribution.errors import DiceParseError


def equal(a: float, b: float, epsilon: float = 1e-6) -> bool:
    return abs(a - b) <= epsilon


def test_d20():
    distribution = parse("1d20")
    assert distribution.min() == 1
    assert distribution.max() == 20
    assert len(distribution.dist) == 20

    for d in range(distribution.min(), distribution.max() + 1):
        assert equal(distribution.get(d), 0.05)


def test_d6():
    distribution = parse("1d6")

    assert equal(distribution.get(1), 0.166666)
    assert equal(distribution.get(2), 0.166666)
    assert equal(distribution.get(3), 0.166666)
    assert equal(distribution.get(4), 0.166666)
    assert equal(distribution.get(5), 0.166666)
    assert equal(distribution.get(6), 0.166666)


def test_3d6():
    distribution = parse("3d6")

    # Verified using anydice.com
    values = [
        (3, 0.0046296296296),
        (4, 0.0138888888889),
        (5, 0.0277777777778),
        (6, 0.0462962962963),
        (7, 0.0694444444444),
        (8, 0.0972222222222),
        (9, 0.1157407407410),
        (10, 0.1250000000000),
        (11, 0.1250000000000),
        (12, 0.1157407407410),
        (13, 0.0972222222222),
        (14, 0.0694444444444),
        (15, 0.0462962962963),
        (16, 0.0277777777778),
        (17, 0.0138888888889),
        (18, 0.0046296296296),
    ]

    for roll, odds in values:
        assert equal(distribution.get(roll), odds)


def test_12d8():
    distribution = parse("12d8")

    # Verified using anydice.com
    values = [
        (12, 0.0145519152284e-9),
        (13, 0.017462298274e-8),
        (14, 0.0113504938781e-7),
        (15, 0.0529689714313e-7),
        (16, 0.0000000198633642867),
        (17, 0.0000000635627657175),
        (18, 0.000000180094502866),
        (19, 0.000000463100150228),
        (20, 0.00000109968823381),
        (21, 0.00000244204420596),
        (22, 0.00000511907273903),
        (23, 0.0000102018238977),
        (24, 0.0000194369640667),
        (25, 0.0000355609226972),
        (26, 0.0000627025729045),
        (27, 0.000106873223558),
        (28, 0.000176528948941),
        (29, 0.000283172295894),
        (30, 0.000441939424491),
        (31, 0.000672096794005),
        (32, 0.000997351438855),
        (33, 0.00144586432725),
        (34, 0.00204985169694),
        (35, 0.00284466985613),
        (36, 0.00386730756145),
        (37, 0.00515425717458),
        (38, 0.00673879939131),
        (39, 0.00864781206474),
        (40, 0.0108982947422),
        (41, 0.0134938778356),
        (42, 0.0164216472767),
        (43, 0.0196496481076),
        (44, 0.0231254245446),
        (45, 0.0267759052804),
        (46, 0.0305088515743),
        (47, 0.0342159572756),
        (48, 0.0377775343659),
        (49, 0.0410685497336),
        (50, 0.0439656183589),
        (51, 0.0463544293307),
        (52, 0.0481370018679),
        (53, 0.0492381497752),
        (54, 0.0496105788043),
        (55, 0.0492381497752),
        (56, 0.0481370018679),
        (57, 0.0463544293307),
        (58, 0.0439656183589),
        (59, 0.0410685497336),
        (60, 0.0377775343659),
        (61, 0.0342159572756),
        (62, 0.0305088515743),
        (63, 0.0267759052804),
        (64, 0.0231254245446),
        (65, 0.0196496481076),
        (66, 0.0164216472767),
        (67, 0.0134938778356),
        (68, 0.0108982947422),
        (69, 0.00864781206474),
        (70, 0.00673879939131),
        (71, 0.00515425717458),
        (72, 0.00386730756145),
        (73, 0.00284466985613),
        (74, 0.00204985169694),
        (75, 0.00144586432725),
        (76, 0.000997351438855),
        (77, 0.000672096794005),
        (78, 0.000441939424491),
        (79, 0.000283172295894),
        (80, 0.000176528948941),
        (81, 0.000106873223558),
        (82, 0.0000627025729045),
        (83, 0.0000355609226972),
        (84, 0.0000194369640667),
        (85, 0.0000102018238977),
        (86, 0.00000511907273903),
        (87, 0.00000244204420596),
        (88, 0.00000109968823381),
        (89, 0.000000463100150228),
        (90, 0.000000180094502866),
        (91, 0.0000000635627657175),
        (92, 0.0000000198633642867),
        (93, 0.0529689714313e-7),
        (94, 0.0113504938781e-7),
        (95, 0.017462298274e-8),
        (96, 0.0145519152284e-9),
    ]

    for roll, odds in values:
        assert equal(distribution.get(roll), odds)


def test_exceptions():
    with pytest.raises(ZeroDivisionError):
        parse("1d6 / 0")

    with pytest.raises(DiceParseError):
        parse("1d20 +")
