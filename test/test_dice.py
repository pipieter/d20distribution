from test import assert_anydice, equal

from d20distribution import parse


def test_0d6():
    distribution = parse("0d6")

    assert equal(distribution.get(0), 1.0)
    assert equal(distribution.get(1), 0.0)
    assert equal(distribution.get(2), 0.0)
    assert equal(distribution.get(3), 0.0)
    assert equal(distribution.get(4), 0.0)
    assert equal(distribution.get(5), 0.0)
    assert equal(distribution.get(6), 0.0)


def test_d6():
    distribution = parse("1d6")

    assert equal(distribution.get(1), 0.166666)
    assert equal(distribution.get(2), 0.166666)
    assert equal(distribution.get(3), 0.166666)
    assert equal(distribution.get(4), 0.166666)
    assert equal(distribution.get(5), 0.166666)
    assert equal(distribution.get(6), 0.166666)


def test_3d6():
    distribution = parse("3d6")
    # Verified using anydice.com
    values = [
        (3, 0.0046296296296),
        (4, 0.0138888888889),
        (5, 0.0277777777778),
        (6, 0.0462962962963),
        (7, 0.0694444444444),
        (8, 0.0972222222222),
        (9, 0.1157407407410),
        (10, 0.1250000000000),
        (11, 0.1250000000000),
        (12, 0.1157407407410),
        (13, 0.0972222222222),
        (14, 0.0694444444444),
        (15, 0.0462962962963),
        (16, 0.0277777777778),
        (17, 0.0138888888889),
        (18, 0.0046296296296),
    ]

    assert_anydice(distribution, values)


def test_12d8():
    distribution = parse("12d8")

    # Verified using anydice.com
    values = [
        (12, 0.0145519152284e-9),
        (13, 0.017462298274e-8),
        (14, 0.0113504938781e-7),
        (15, 0.0529689714313e-7),
        (16, 0.0000000198633642867),
        (17, 0.0000000635627657175),
        (18, 0.000000180094502866),
        (19, 0.000000463100150228),
        (20, 0.00000109968823381),
        (21, 0.00000244204420596),
        (22, 0.00000511907273903),
        (23, 0.0000102018238977),
        (24, 0.0000194369640667),
        (25, 0.0000355609226972),
        (26, 0.0000627025729045),
        (27, 0.000106873223558),
        (28, 0.000176528948941),
        (29, 0.000283172295894),
        (30, 0.000441939424491),
        (31, 0.000672096794005),
        (32, 0.000997351438855),
        (33, 0.00144586432725),
        (34, 0.00204985169694),
        (35, 0.00284466985613),
        (36, 0.00386730756145),
        (37, 0.00515425717458),
        (38, 0.00673879939131),
        (39, 0.00864781206474),
        (40, 0.0108982947422),
        (41, 0.0134938778356),
        (42, 0.0164216472767),
        (43, 0.0196496481076),
        (44, 0.0231254245446),
        (45, 0.0267759052804),
        (46, 0.0305088515743),
        (47, 0.0342159572756),
        (48, 0.0377775343659),
        (49, 0.0410685497336),
        (50, 0.0439656183589),
        (51, 0.0463544293307),
        (52, 0.0481370018679),
        (53, 0.0492381497752),
        (54, 0.0496105788043),
        (55, 0.0492381497752),
        (56, 0.0481370018679),
        (57, 0.0463544293307),
        (58, 0.0439656183589),
        (59, 0.0410685497336),
        (60, 0.0377775343659),
        (61, 0.0342159572756),
        (62, 0.0305088515743),
        (63, 0.0267759052804),
        (64, 0.0231254245446),
        (65, 0.0196496481076),
        (66, 0.0164216472767),
        (67, 0.0134938778356),
        (68, 0.0108982947422),
        (69, 0.00864781206474),
        (70, 0.00673879939131),
        (71, 0.00515425717458),
        (72, 0.00386730756145),
        (73, 0.00284466985613),
        (74, 0.00204985169694),
        (75, 0.00144586432725),
        (76, 0.000997351438855),
        (77, 0.000672096794005),
        (78, 0.000441939424491),
        (79, 0.000283172295894),
        (80, 0.000176528948941),
        (81, 0.000106873223558),
        (82, 0.0000627025729045),
        (83, 0.0000355609226972),
        (84, 0.0000194369640667),
        (85, 0.0000102018238977),
        (86, 0.00000511907273903),
        (87, 0.00000244204420596),
        (88, 0.00000109968823381),
        (89, 0.000000463100150228),
        (90, 0.000000180094502866),
        (91, 0.0000000635627657175),
        (92, 0.0000000198633642867),
        (93, 0.0529689714313e-7),
        (94, 0.0113504938781e-7),
        (95, 0.017462298274e-8),
        (96, 0.0145519152284e-9),
    ]

    assert_anydice(distribution, values)


def test_complex_expression():
    distribution = parse("16d12 - 3d6 + 2d4 + 5")

    values = [
        (5, 0.0156504319828e-19),
        (6, 0.0328659071638e-18),
        (7, 0.0361524978802e-17),
        (8, 0.0277169150415e-16),
        (9, 0.0166270189385e-15),
        (10, 0.08308501331e-15),
        (11, 0.0359592150452e-14),
        (12, 0.0138416333063e-13),
        (13, 0.0482997528183e-13),
        (14, 0.0154993317571e-12),
        (15, 0.0462515870449e-12),
        (16, 0.0129489736702e-11),
        (17, 0.0342584730548e-11),
        (18, 0.0861612345193e-11),
        (19, 0.0207032095531e-10),
        (20, 0.0477297052242e-10),
        (21, 0.0105961282057e-9),
        (22, 0.0227239054739e-9),
        (23, 0.0472053738879e-9),
        (24, 0.0952187687615e-9),
        (25, 0.0186897633514e-8),
        (26, 0.0357650207038e-8),
        (27, 0.0668375635699e-8),
        (28, 0.012216508113e-7),
        (29, 0.0218689440512e-7),
        (30, 0.0383878847844e-7),
        (31, 0.0661494563317e-7),
        (32, 0.0000000112010572441),
        (33, 0.0000000186546633239),
        (34, 0.0000000305823714049),
        (35, 0.0000000493899451032),
        (36, 0.0000000786302980514),
        (37, 0.000000123481158809),
        (38, 0.000000191392072152),
        (39, 0.00000029294946917),
        (40, 0.000000443018690585),
        (41, 0.000000662232898279),
        (42, 0.000000978910444141),
        (43, 0.00000143149401467),
        (44, 0.00000207161609231),
        (45, 0.00000296790513862),
        (46, 0.000004210654383),
        (47, 0.0000059174789758),
        (48, 0.00000824008614777),
        (49, 0.0000113722753885),
        (50, 0.0000155592699197),
        (51, 0.0000211084553058),
        (52, 0.0000284015644296),
        (53, 0.0000379082990132),
        (54, 0.0000502013154867),
        (55, 0.0000659724269265),
        (56, 0.0000860497832874),
        (57, 0.000111415690328),
        (58, 0.000143224615522),
        (59, 0.000182820809917),
        (60, 0.000231754852523),
        (61, 0.000291798303607),
        (62, 0.000364955541548),
        (63, 0.000453471761768),
        (64, 0.000559836043528),
        (65, 0.000686778349172),
        (66, 0.000837259318797),
        (67, 0.00101445176892),
        (68, 0.00122171290305),
        (69, 0.00146254640006),
        (70, 0.0017405537663),
        (71, 0.00205937461888),
        (72, 0.00242261590924),
        (73, 0.00283377049064),
        (74, 0.00329612587225),
        (75, 0.0038126644724),
        (76, 0.00438595716852),
        (77, 0.00501805242178),
        (78, 0.00571036370961),
        (79, 0.00646355840569),
        (80, 0.00727745158149),
        (81, 0.00815090844397),
        (82, 0.00908175924863),
        (83, 0.0100667305195),
        (84, 0.0111013962538),
        (85, 0.0121801524816),
        (86, 0.0132962180872),
        (87, 0.0144416641874),
        (88, 0.0156074736116),
        (89, 0.0167836311627),
        (90, 0.0179592443813),
        (91, 0.0191226935223),
        (92, 0.0202618084191),
        (93, 0.0213640688992),
        (94, 0.0224168244657),
        (95, 0.0234075281165),
        (96, 0.0243239784722),
        (97, 0.0251545638651),
        (98, 0.0258885017283),
        (99, 0.0265160665391),
        (100, 0.0270287997238),
        (101, 0.0274196953249),
        (102, 0.0276833558541),
        (103, 0.0278161135896),
        (104, 0.0278161135896),
        (105, 0.0276833558541),
        (106, 0.0274196953249),
        (107, 0.0270287997238),
        (108, 0.0265160665391),
        (109, 0.0258885017283),
        (110, 0.0251545638651),
        (111, 0.0243239784722),
        (112, 0.0234075281165),
        (113, 0.0224168244657),
        (114, 0.0213640688992),
        (115, 0.0202618084191),
        (116, 0.0191226935223),
        (117, 0.0179592443813),
        (118, 0.0167836311627),
        (119, 0.0156074736116),
        (120, 0.0144416641874),
        (121, 0.0132962180872),
        (122, 0.0121801524816),
        (123, 0.0111013962538),
        (124, 0.0100667305195),
        (125, 0.00908175924863),
        (126, 0.00815090844397),
        (127, 0.00727745158149),
        (128, 0.00646355840569),
        (129, 0.00571036370961),
        (130, 0.00501805242178),
        (131, 0.00438595716852),
        (132, 0.0038126644724),
        (133, 0.00329612587225),
        (134, 0.00283377049064),
        (135, 0.00242261590924),
        (136, 0.00205937461888),
        (137, 0.0017405537663),
        (138, 0.00146254640006),
        (139, 0.00122171290305),
        (140, 0.00101445176892),
        (141, 0.000837259318797),
        (142, 0.000686778349172),
        (143, 0.000559836043528),
        (144, 0.000453471761768),
        (145, 0.000364955541548),
        (146, 0.000291798303607),
        (147, 0.000231754852523),
        (148, 0.000182820809917),
        (149, 0.000143224615522),
        (150, 0.000111415690328),
        (151, 0.0000860497832874),
        (152, 0.0000659724269265),
        (153, 0.0000502013154867),
        (154, 0.0000379082990132),
        (155, 0.0000284015644296),
        (156, 0.0000211084553058),
        (157, 0.0000155592699197),
        (158, 0.0000113722753885),
        (159, 0.00000824008614777),
        (160, 0.0000059174789758),
        (161, 0.000004210654383),
        (162, 0.00000296790513862),
        (163, 0.00000207161609231),
        (164, 0.00000143149401467),
        (165, 0.000000978910444141),
        (166, 0.000000662232898279),
        (167, 0.000000443018690585),
        (168, 0.00000029294946917),
        (169, 0.000000191392072152),
        (170, 0.000000123481158809),
        (171, 0.0000000786302980514),
        (172, 0.0000000493899451032),
        (173, 0.0000000305823714049),
        (174, 0.0000000186546633239),
        (175, 0.0000000112010572441),
        (176, 0.0661494563317e-7),
        (177, 0.0383878847844e-7),
        (178, 0.0218689440512e-7),
        (179, 0.012216508113e-7),
        (180, 0.0668375635699e-8),
        (181, 0.0357650207038e-8),
        (182, 0.0186897633514e-8),
        (183, 0.0952187687615e-9),
        (184, 0.0472053738879e-9),
        (185, 0.0227239054739e-9),
        (186, 0.0105961282057e-9),
        (187, 0.0477297052242e-10),
        (188, 0.0207032095531e-10),
        (189, 0.0861612345193e-11),
        (190, 0.0342584730548e-11),
        (191, 0.0129489736702e-11),
        (192, 0.0462515870449e-12),
        (193, 0.0154993317571e-12),
        (194, 0.0482997528183e-13),
        (195, 0.0138416333063e-13),
        (196, 0.0359592150452e-14),
        (197, 0.08308501331e-15),
        (198, 0.0166270189385e-15),
        (199, 0.0277169150415e-16),
        (200, 0.0361524978802e-17),
        (201, 0.0328659071638e-18),
        (202, 0.0156504319828e-19),
    ]

    assert_anydice(distribution, values)


def test_advantage():
    distribution = parse("1d20").advantage()

    values = [
        (1, 0.0025),
        (2, 0.0075),
        (3, 0.0125),
        (4, 0.0175),
        (5, 0.0225),
        (6, 0.0275),
        (7, 0.0325),
        (8, 0.0375),
        (9, 0.0425),
        (10, 0.0475),
        (11, 0.0525),
        (12, 0.0575),
        (13, 0.0625),
        (14, 0.0675),
        (15, 0.0725),
        (16, 0.0775),
        (17, 0.0825),
        (18, 0.0875),
        (19, 0.0925),
        (20, 0.0975),
    ]

    assert_anydice(distribution, values)


def test_advantage_5():
    distribution = parse("1d20").advantage(count=5)

    values = [
        (1, 0.0000003125),
        (2, 0.0000096875),
        (3, 0.0000659375),
        (4, 0.0002440625),
        (5, 0.0006565625),
        (6, 0.0014534375),
        (7, 0.0028221875),
        (8, 0.0049878125),
        (9, 0.0082128125),
        (10, 0.0127971875),
        (11, 0.0190784375),
        (12, 0.0274315625),
        (13, 0.0382690625),
        (14, 0.0520409375),
        (15, 0.0692346875),
        (16, 0.0903753125),
        (17, 0.1160253125),
        (18, 0.1467846875),
        (19, 0.1832909375),
        (20, 0.2262190625),
    ]

    assert_anydice(distribution, values)


def test_disadvantage():
    distribution = parse("1d20").disadvantage()

    values = [
        (1, 0.0975),
        (2, 0.0925),
        (3, 0.0875),
        (4, 0.0825),
        (5, 0.0775),
        (6, 0.0725),
        (7, 0.0675),
        (8, 0.0625),
        (9, 0.0575),
        (10, 0.0525),
        (11, 0.0475),
        (12, 0.0425),
        (13, 0.0375),
        (14, 0.0325),
        (15, 0.0275),
        (16, 0.0225),
        (17, 0.0175),
        (18, 0.0125),
        (19, 0.0075),
        (20, 0.0025),
    ]

    assert_anydice(distribution, values)


def test_disadvantage_4():
    distribution = parse("1d20").disadvantage(count=4)

    values = [
        (1, 0.18549375),
        (2, 0.15840625),
        (3, 0.13409375),
        (4, 0.11240625),
        (5, 0.09319375),
        (6, 0.07630625),
        (7, 0.06159375),
        (8, 0.04890625),
        (9, 0.03809375),
        (10, 0.02900625),
        (11, 0.02149375),
        (12, 0.01540625),
        (13, 0.01059375),
        (14, 0.00690625),
        (15, 0.00419375),
        (16, 0.00230625),
        (17, 0.00109375),
        (18, 0.00040625),
        (19, 0.00009375),
        (20, 0.00000625),
    ]

    assert_anydice(distribution, values)
